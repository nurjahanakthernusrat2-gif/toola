name: Authentication Scanner

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "Target Login Page URL (e.g., https://example.com/login)"
        required: true
        default: ""
      project_name:
        description: "Project Name for Report Folder"
        required: true
        default: "auth-project"

run-name: "Auth Scan → ${{ github.event.inputs.target_url }}"

jobs:
  auth_scan:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Setup Python
      run: |
        python3 -m venv .venv
        source .venv/bin/activate
        pip install --upgrade pip
        pip install requests beautifulsoup4 lxml

    - name: Prepare Inputs
      id: prep
      run: |
        echo "url=${{ github.event.inputs.target_url }}" >> $GITHUB_OUTPUT
        echo "project=${{ github.event.inputs.project_name }}" >> $GITHUB_OUTPUT

    - name: Run All Authentication Tests (A–Z)
      run: |
        source .venv/bin/activate
        mkdir -p results

        echo "[+] Running Test A–Z …"

        TEST_DIR="tests/auth"

        for test_file in $(ls -1 $TEST_DIR/*.py); do
            echo "[+] Running $(basename $test_file)"
            python "$test_file" "${{ steps.prep.outputs.url }}" > "results/$(basename $test_file .py).json"
        done

        echo "[+] All tests completed."

    - name: Generate HTML Report
      run: |
        source .venv/bin/activate
        python report/generate_html_report.py \
          --input results \
          --output report.html \
          --project "${{ steps.prep.outputs.project }}" \
          --target "${{ steps.prep.outputs.url }}"

    - name: Upload Report Artifact
      uses: actions/upload-artifact@v4
      with:
        name: auth-report-${{ github.run_id }}
        path: report.html

    # OPTIONAL → Enable only if you want S3 upload
    # - name: Upload Report to S3
    #   run: |
    #     aws s3 cp report.html s3://your-bucket/auth-reports/${{ steps.prep.outputs.project }}/ --acl private
